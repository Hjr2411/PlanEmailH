<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>PlanEmailH</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"></script>
<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: #f9f9f9;
  color: #333;
  margin: 0; padding: 0;
}
.container {
  max-width: 1200px;
  margin: 20px auto;
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
h2 { margin-top: 0; }
form, .actions {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
}
input, button {
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 14px;
}
button {
  cursor: pointer;
  background: #0078d7;
  color: white;
  border: none;
}
button:hover {
  background: #005a9e;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}
th, td {
  padding: 5px;
  border: 1px solid #ccc;
  text-align: left;
  font-size: 13px;
}
.thermo.green { background: #d4edda; }
.thermo.yellow { background: #fff3cd; }
.thermo.red { background: #f8d7da; }
</style>
</head>
<body>

<div class="container">
  <h2>PlanEmailH</h2>

  <form id="registroForm">
    <input type="text" id="analista" placeholder="Analista" required>
    <input type="text" id="chamado" placeholder="Chamado" required>
    <input type="text" id="email" placeholder="E-mail enviado" required>
    <button type="submit">Registrar</button>
  </form>

  <div class="actions">
    <button id="exportar">Exportar para Excel</button>
  </div>

  <table id="tabela">
    <thead>
      <tr>
        <th>Termômetro</th>
        <th>Analista</th>
        <th>Chamado</th>
        <th>E-mail enviado</th>
        <th>Atualização</th>
        <th>Data Atualização</th>
        <th>Ação</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBCAnTFGReRhjXKeSeGrcH3enK6lL_Uf_Y",
  authDomain: "planh-55e03.firebaseapp.com",
  databaseURL: "https://planh-55e03-default-rtdb.firebaseio.com",
  projectId: "planh-55e03",
  storageBucket: "planh-55e03.appspot.com",
  messagingSenderId: "288085753915",
  appId: "1:288085753915:web:f413cff93946f357f71c1e"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const tbody = document.querySelector("#tabela tbody");

document.getElementById('registroForm').addEventListener('submit', e => {
  e.preventDefault();
  const dados = {
    analista: document.getElementById('analista').value,
    chamado: document.getElementById('chamado').value,
    email: document.getElementById('email').value,
    atualizacao: '',
    dataAtualizacao: ''
  };
  db.ref('planemailh/').push(dados);
  document.getElementById('registroForm').reset();
});

function carregar() {
  db.ref('planemailh/').on('value', snap => {
    tbody.innerHTML = "";
    snap.forEach(child => {
      const d = child.val();
      const key = child.key;
      const tr = document.createElement("tr");

      const diffDays = calcDiffDays(d.dataAtualizacao);
      let cor = "green";
      if (diffDays >= 2) cor = "red";
      else if (diffDays == 1) cor = "yellow";

      tr.innerHTML = `
        <td class="thermo ${cor}"></td>
        <td>${d.analista}</td>
        <td>${d.chamado}</td>
        <td>${d.email}</td>
        <td>${d.atualizacao || '-'}</td>
        <td>${d.dataAtualizacao || '-'}</td>
        <td><button onclick="atualizar('${key}')">Atualizar</button></td>
      `;
      tbody.appendChild(tr);
    });
  });
}

function calcDiffDays(data) {
  if (!data) return 999;
  const dt = new Date(data);
  const hoje = new Date();
  const diff = (hoje - dt) / (1000 * 60 * 60 * 24);
  return Math.floor(diff);
}

function atualizar(key) {
  const texto = prompt("Digite a atualização:");
  if (!texto) return;
  const agora = new Date().toLocaleString();
  db.ref('planemailh/' + key).update({
    atualizacao: texto,
    dataAtualizacao: agora
  });
}

document.getElementById('exportar').onclick = () => {
  let csv = "Analista,Chamado,E-mail,Atualização,Data Atualização\n";
  document.querySelectorAll("#tabela tbody tr").forEach(tr => {
    const cols = tr.querySelectorAll("td");
    csv += `${cols[1].textContent},${cols[2].textContent},${cols[3].textContent},${cols[4].textContent},${cols[5].textContent}\n`;
  });
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "PlanEmailH.csv";
  a.click();
  URL.revokeObjectURL(url);
}

carregar();
</script>

</body>
</html>
