<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>PlanEmailH</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"></script>
<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: #f9f9f9;
  color: #333;
  margin: 0; padding: 0;
}
.container {
  max-width: 1200px;
  margin: 20px auto;
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
h2 { margin-top: 0; }
form, .actions {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
}
input, select, button {
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 14px;
}
button {
  cursor: pointer;
  background: #0078d7;
  color: white;
  border: none;
}
button:hover {
  background: #005a9e;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}
th, td {
  padding: 5px;
  border: 1px solid #ccc;
  text-align: left;
  font-size: 13px;
}
.sem-verde { color: green; }
.sem-verde-escuro { color: darkgreen; }
.sem-amarelo { color: goldenrod; }
.sem-vermelho { color: red; }
.concluido { background-color: #eee; color: #999; }
button.small { font-size: 12px; padding: 4px; }
</style>
</head>
<body>

<div class="container">
  <h2>PlanEmailH</h2>

  <form id="registroForm">
    <input type="text" id="analista" placeholder="Analista" required>
    <input type="text" id="chamado" placeholder="Chamado" required>
    <input type="date" id="dataAbertura" required>
    <input type="date" id="dataEnvioN3">
    <input type="text" id="fila" placeholder="Fila Encaminhamento">
    <select id="status">
      <option>Aguardando Fornecedor</option>
      <option>NÃ£o Enviado ao N3</option>
      <option>Resolvido</option>
      <option>Outros</option>
    </select>
    <input type="text" id="atualizacao" placeholder="AtualizaÃ§Ã£o">
    <button type="submit">Registrar</button>
  </form>

  <div class="actions">
    <button id="organizar">Organizar por Analista</button>
  </div>

  <table id="tabela">
    <thead>
      <tr>
        <th>ðŸš¦</th>
        <th>Analista</th>
        <th>Chamado</th>
        <th>Data Abertura</th>
        <th>Data Envio N3</th>
        <th>Fila</th>
        <th>Status</th>
        <th>AtualizaÃ§Ã£o</th>
        <th>Data AtualizaÃ§Ã£o</th>
        <th>AÃ§Ãµes</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const firebaseConfig = {
  // ðŸ”· Coloque aqui seu config do Firebase ðŸ”·
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const tbody = document.querySelector("#tabela tbody");

document.getElementById('registroForm').addEventListener('submit', e => {
  e.preventDefault();
  const dados = {
    analista: analista.value,
    chamado: chamado.value,
    dataAbertura: dataAbertura.value,
    dataEnvioN3: dataEnvioN3.value,
    fila: fila.value,
    status: status.value,
    atualizacao: atualizacao.value,
    dataAtualizacao: '',
    concluido: false,
    criadoEm: Date.now()
  };
  db.ref('planemailh/').push(dados);
  registroForm.reset();
});

let organizarPorAnalista = false;

document.getElementById('organizar').onclick = () => {
  organizarPorAnalista = !organizarPorAnalista;
  carregar();
};

function carregar() {
  db.ref('planemailh/').on('value', snap => {
    let ativos = [], concluidos = [];
    snap.forEach(child => {
      const d = child.val();
      d.key = child.key;
      if (d.concluido) concluidos.push(d);
      else ativos.push(d);
    });

    if (organizarPorAnalista) {
      const analistaAtual = prompt("Qual analista para priorizar?") || '';
      ativos.sort((a, b) => {
        if (a.analista === analistaAtual && b.analista !== analistaAtual) return -1;
        if (a.analista !== analistaAtual && b.analista === analistaAtual) return 1;
        return ordemTermometro(a, b) || a.criadoEm - b.criadoEm;
      });
    } else {
      ativos.sort((a, b) => ordemTermometro(a, b) || a.criadoEm - b.criadoEm);
    }

    tbody.innerHTML = "";
    [...ativos, ...concluidos].forEach(d => {
      const tr = document.createElement("tr");
      if (d.concluido) tr.classList.add("concluido");

      const diff = calcDiffDays(d.dataAtualizacao);
      let semaforo = '';
      if (!d.concluido) {
        if (diff === 0) semaforo = `<span class="sem-verde">ðŸŸ¢</span>`;
        else if (diff === 1) semaforo = `<span class="sem-verde-escuro">ðŸŸ¢</span>`;
        else if (diff === 2) semaforo = `<span class="sem-amarelo">ðŸŸ¡</span>`;
        else semaforo = `<span class="sem-vermelho">ðŸ”´</span>`;
      }

      tr.innerHTML = `
        <td>${semaforo}</td>
        <td>${d.analista}</td>
        <td>${d.chamado}</td>
        <td>${d.dataAbertura}</td>
        <td>${d.dataEnvioN3}</td>
        <td>${d.fila}</td>
        <td>${d.status}</td>
        <td>${d.atualizacao || '-'}</td>
        <td>${d.dataAtualizacao || '-'}</td>
        <td>
          ${!d.concluido ? `
          <button class="small" onclick="atualizar('${d.key}')">ðŸ”„</button>
          <button class="small" onclick="concluir('${d.key}')">âœ…</button>` : ''}
        </td>
      `;
      tbody.appendChild(tr);
    });
  });
}

function ordemTermometro(a, b) {
  const tA = calcDiffDays(a.dataAtualizacao);
  const tB = calcDiffDays(b.dataAtualizacao);
  return tB - tA;
}

function calcDiffDays(data) {
  if (!data) return 999;
  const dt = new Date(data);
  const hoje = new Date();
  return Math.floor((hoje - dt) / (1000 * 60 * 60 * 24));
}

function atualizar(key) {
  const texto = prompt("Digite a nova atualizaÃ§Ã£o:");
  if (!texto) return;
  const agora = new Date().toLocaleString();
  db.ref('planemailh/' + key).update({
    atualizacao: texto,
    dataAtualizacao: agora
  });
}

function concluir(key) {
  db.ref('planemailh/' + key).update({ concluido: true });
}

carregar();
</script>

</body>
</html>
