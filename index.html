<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlanEmailH - Sistema de Gestão de E-mails N3</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="glass-card rounded-lg p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-envelope-open-text text-blue-600 mr-3"></i>
                        PlanEmailH
                    </h1>
                    <p class="text-gray-600">Sistema de Gestão de E-mails N3</p>
                </div>
                <div id="userInfo" class="text-right hidden">
                    <div class="flex items-center gap-4">
                        <div>
                            <p class="text-sm text-gray-600">Usuário Logado:</p>
                            <p id="currentUser" class="font-semibold text-gray-800"></p>
                        </div>
                        <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition-colors">
                            <i class="fas fa-sign-out-alt mr-2"></i>Sair
                        </button>
                    </div>
                </div>
            </div>

            <!-- Connection Status -->
            <div id="connectionStatus" class="mb-4 p-3 rounded-lg bg-yellow-100 border-l-4 border-yellow-500 hidden">
                <div class="flex items-center">
                    <i class="fas fa-wifi text-yellow-600 mr-2"></i>
                    <span id="statusText" class="text-yellow-800">Conectando...</span>
                </div>
            </div>

            <!-- Search and Filter Controls -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 hidden" id="controls">
                <div>
                    <input type="text" id="searchInput" placeholder="Buscar por analista, chamado ou assunto..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <select id="statusFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Todos os Status</option>
                        <option value="Pendente">Pendente</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Concluído">Concluído</option>
                        <option value="Cancelado">Cancelado</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <button id="addChamadoBtn" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Novo Chamado
                    </button>
                    <button id="exportBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-file-excel mr-2"></i>Exportar
                    </button>
                </div>
            </div>
        </div>

        <!-- Admin Section (visible only for admins) -->
        <div id="adminSection" class="glass-card rounded-lg p-6 mb-8 hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-users-cog mr-2"></i>Gestão de Usuários
                </h2>
                <button id="addUserBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-user-plus mr-2"></i>Adicionar Usuário
                </button>
            </div>
            <div id="usersList" class="space-y-4">
                <!-- Usuários serão carregados aqui dinamicamente -->
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 hidden" id="statsCards">
            <div class="glass-card rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total</p>
                        <p id="totalChamados" class="text-2xl font-bold text-gray-900">0</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full">
                        <i class="fas fa-list text-blue-600"></i>
                    </div>
                </div>
            </div>
            <div class="glass-card rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Pendentes</p>
                        <p id="pendenteChamados" class="text-2xl font-bold text-yellow-600">0</p>
                    </div>
                    <div class="bg-yellow-100 p-3 rounded-full">
                        <i class="fas fa-clock text-yellow-600"></i>
                    </div>
                </div>
            </div>
            <div class="glass-card rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Em Andamento</p>
                        <p id="andamentoChamados" class="text-2xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full">
                        <i class="fas fa-play text-blue-600"></i>
                    </div>
                </div>
            </div>
            <div class="glass-card rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Concluídos</p>
                        <p id="concluidoChamados" class="text-2xl font-bold text-green-600">0</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full">
                        <i class="fas fa-check text-green-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chamados List -->
        <div id="chamadosContainer" class="glass-card rounded-lg p-6 hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-list mr-2"></i>Lista de Chamados
            </h2>
            <div id="chamadosList" class="space-y-4">
                <!-- Chamados will be dynamically loaded here -->
            </div>
        </div>

        <!-- Login Modal -->
        <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="glass-card max-w-md w-full mx-4 p-8 rounded-lg">
                <div class="text-center mb-6">
                    <i class="fas fa-lock text-4xl text-blue-600 mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-800">Login</h2>
                    <p class="text-gray-600">Entre com suas credenciais</p>
                </div>
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Usuário</label>
                        <input type="text" id="username" name="username" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Digite seu usuário">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                        <input type="password" id="password" name="password" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Digite sua senha">
                    </div>
                    <button type="submit" id="loginBtn" 
                            class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-sign-in-alt mr-2"></i>Entrar
                    </button>
                </form>
                <div id="loginError" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded hidden">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span id="loginErrorText">Credenciais inválidas</span>
                </div>
            </div>
        </div>

        <!-- Add/Edit Chamado Modal -->
        <div id="chamadoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="glass-card max-w-2xl w-full mx-4 p-8 rounded-lg max-h-screen overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="modalTitle" class="text-2xl font-bold text-gray-800">Novo Chamado</h2>
                    <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="chamadoForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="analista" class="block text-sm font-medium text-gray-700 mb-2">Analista *</label>
                            <input type="text" id="analista" name="analista" required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label for="chamado" class="block text-sm font-medium text-gray-700 mb-2">Chamado *</label>
                            <input type="text" id="chamado" name="chamado" required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="sistema" class="block text-sm font-medium text-gray-700 mb-2">Sistema *</label>
                            <input type="text" id="sistema" name="sistema" required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label for="cenario" class="block text-sm font-medium text-gray-700 mb-2">Cenário *</label>
                            <input type="text" id="cenario" name="cenario" required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    <div>
                        <label for="assunto" class="block text-sm font-medium text-gray-700 mb-2">Assunto do E-mail *</label>
                        <textarea id="assunto" name="assunto" required rows="3"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="dataAbertura" class="block text-sm font-medium text-gray-700 mb-2">Data de Abertura *</label>
                            <input type="date" id="dataAbertura" name="dataAbertura" required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label for="dataEnvioN3" class="block text-sm font-medium text-gray-700 mb-2">Data de Envio para o N3 *</label>
                            <input type="date" id="dataEnvioN3" name="dataEnvioN3" required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label for="fila" class="block text-sm font-medium text-gray-700 mb-2">Fila *</label>
                            <input type="text" id="fila" name="fila" required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    <div>
                        <label for="status" class="block text-sm font-medium text-gray-700 mb-2">Status *</label>
                        <select id="status" name="status" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Selecione o status</option>
                            <option value="Pendente">Pendente</option>
                            <option value="Em Andamento">Em Andamento</option>
                            <option value="Concluído">Concluído</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                    </div>
                    <div>
                        <label for="atualizacaoInicial" class="block text-sm font-medium text-gray-700 mb-2">Atualização Inicial</label>
                        <textarea id="atualizacaoInicial" name="atualizacaoInicial" rows="4"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  placeholder="Descreva as informações iniciais do chamado..."></textarea>
                    </div>
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="cancelBtn" 
                                class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            Cancelar
                        </button>
                        <button type="submit" id="saveBtn" 
                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-save mr-2"></i>Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add/Edit User Modal -->
        <div id="userModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="glass-card max-w-md w-full mx-4 p-8 rounded-lg">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="userModalTitle" class="text-2xl font-bold text-gray-800">Novo Usuário</h2>
                    <button id="closeUserModalBtn" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="userForm" class="space-y-4">
                    <div>
                        <label for="newUsername" class="block text-sm font-medium text-gray-700 mb-2">Nome de Usuário *</label>
                        <input type="text" id="newUsername" name="username" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Digite o nome de usuário">
                    </div>
                    <div>
                        <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-2">Senha *</label>
                        <input type="password" id="newPassword" name="password" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Digite a senha">
                    </div>
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-2">Nome Completo</label>
                        <input type="text" id="name" name="name"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Digite o nome completo">
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="isAdmin" name="isAdmin" class="mr-2 h-5 w-5">
                        <label for="isAdmin" class="text-sm font-medium text-gray-700">Usuário Administrador</label>
                    </div>
                    <div class="flex justify-end space-x-4 pt-4">
                        <button type="button" id="cancelUserBtn" 
                                class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            Cancelar
                        </button>
                        <button type="submit" id="saveUserBtn" 
                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-save mr-2"></i>Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- View Chamado Modal -->
        <div id="viewChamadoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="glass-card max-w-3xl w-full mx-4 p-8 rounded-lg max-h-screen overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="viewModalTitle" class="text-2xl font-bold text-gray-800">Detalhes do Chamado</h2>
                    <button id="closeViewModalBtn" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="chamadoDetails" class="space-y-6">
                    <!-- Detalhes do chamado serão carregados aqui -->
                </div>
                <div class="mt-6 pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-medium text-gray-800 mb-4">Histórico de Atualizações</h3>
                    <div id="chamadoUpdates" class="space-y-4">
                        <!-- Atualizações serão carregadas aqui -->
                    </div>
                </div>
                <div class="mt-6 pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-medium text-gray-800 mb-4">Adicionar Atualização</h3>
                    <form id="updateForm" class="space-y-4">
                        <textarea id="updateContent" name="updateContent" rows="3" required
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  placeholder="Digite a atualização..."></textarea>
                        <div class="flex justify-end">
                            <button type="submit" id="saveUpdateBtn" 
                                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                <i class="fas fa-plus-circle mr-2"></i>Adicionar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"></script>
    <script type="module">
        // Firebase Configuration - INICIALIZAÇÃO ÚNICA
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getDatabase, 
            ref, 
            set, 
            get, 
            push, 
            remove, 
            onValue,
            off,
            update
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Configuração do Firebase - substitua pelos seus dados
        const firebaseConfig = {
            // Import the functions you need from the SDKs you need
//import { initializeApp } from "firebase/app";
//import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
//const firebaseConfig = {
  apiKey: "AIzaSyBCAnTFGReRhjXKeSeGrcH3enK6lL_Uf_Y",
  authDomain: "planh-55e03.firebaseapp.com",
  databaseURL: "https://planh-55e03-default-rtdb.firebaseio.com",
  projectId: "planh-55e03",
  storageBucket: "planh-55e03.firebasestorage.app",
  messagingSenderId: "288085753915",
  appId: "1:288085753915:web:f413cff93946f357f71c1e",
  measurementId: "G-6N2W83NT2N"
};

// Initialize Firebase
//const app = initializeApp(firebaseConfig);
//const analytics = getAnalytics(app);
      //  };

        // Inicializar Firebase - APENAS UMA VEZ
        let app, database;
        let currentUser = null;
        let chamadosData = {};
        let usersData = {};
        let connectionRef = null;
        let isConnected = false;
        let currentViewChamadoId = null;

        // Inicializa o Firebase e configura o monitoramento de conexão
        function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                database = getDatabase(app);
                
                // Monitor connection status
                connectionRef = ref(database, '.info/connected');
                onValue(connectionRef, (snapshot) => {
                    isConnected = snapshot.val();
                    updateConnectionStatus();
                    
                    if (isConnected) {
                        showConnectionStatus('Conectado ao Firebase', 'success');
                        setTimeout(() => {
                            document.getElementById('connectionStatus').classList.add('hidden');
                        }, 3000);
                    } else {
                        showConnectionStatus('Desconectado - Tentando reconectar...', 'error');
                    }
                });
                
                console.log('Firebase inicializado com sucesso');
                checkSession();
                return true;
            } catch (error) {
                console.error('Firebase initialization error:', error);
                showConnectionStatus('Erro na conexão com o Firebase', 'error');
                return false;
            }
        }

        // Exibir status de conexão
        function updateConnectionStatus() {
            const statusDiv = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            
            statusDiv.classList.remove('hidden');
            
            if (isConnected) {
                statusDiv.className = 'mb-4 p-3 rounded-lg bg-green-100 border-l-4 border-green-500';
                statusText.innerHTML = '<i class="fas fa-check-circle text-green-600 mr-2"></i>Conectado';
                statusText.className = 'text-green-800';
            } else {
                statusDiv.className = 'mb-4 p-3 rounded-lg bg-red-100 border-l-4 border-red-500';
                statusText.innerHTML = '<i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>Desconectado - Tentando reconectar...';
                statusText.className = 'text-red-800';
            }
        }

        function showConnectionStatus(message, type = 'info') {
            const statusDiv = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            
            statusDiv.classList.remove('hidden');
            
            let className, iconClass, textClass;
            switch (type) {
                case 'success':
                    className = 'mb-4 p-3 rounded-lg bg-green-100 border-l-4 border-green-500';
                    iconClass = 'fas fa-check-circle text-green-600 mr-2';
                    textClass = 'text-green-800';
                    break;
                case 'error':
                    className = 'mb-4 p-3 rounded-lg bg-red-100 border-l-4 border-red-500';
                    iconClass = 'fas fa-exclamation-triangle text-red-600 mr-2';
                    textClass = 'text-red-800';
                    break;
                default:
                    className = 'mb-4 p-3 rounded-lg bg-blue-100 border-l-4 border-blue-500';
                    iconClass = 'fas fa-info-circle text-blue-600 mr-2';
                    textClass = 'text-blue-800';
            }
            
            statusDiv.className = className;
            statusText.innerHTML = `<i class="$${iconClass}"></i>$${message}`;
            statusText.className = textClass;
        }

        // Gerenciamento de sessão
        function saveUserSession(user) {
            localStorage.setItem('planEmailUser', JSON.stringify(user));
        }

        function loadUserSession() {
            const savedUser = localStorage.getItem('planEmailUser');
            if (savedUser) {
                return JSON.parse(savedUser);
            }
            return null;
        }

        function clearUserSession() {
            localStorage.removeItem('planEmailUser');
        }

        function checkSession() {
            const savedUser = loadUserSession();
            if (savedUser) {
                // Verificar se o usuário ainda existe no banco
                const userRef = ref(database, `users/${savedUser.username}`);
                get(userRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        currentUser = savedUser;
                        showMainInterface();
                        loadChamados();
                        if (currentUser.admin) {
                            loadUsers();
                        }
                    } else {
                        clearUserSession();
                        showLoginModal();
                    }
                }).catch(error => {
                    console.error("Erro ao verificar sessão:", error);
                    clearUserSession();
                    showLoginModal();
                });
            } else {
                showLoginModal();
            }
        }

        // Sistema de login simplificado usando Firebase Realtime Database
        async function login(username, password) {
            try {
                showConnectionStatus('Verificando credenciais...', 'info');
                
                const userRef = ref(database, `users/${username}`);
                const snapshot = await get(userRef);
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    if (userData.password === password) {
                        // Login bem-sucedido
                        currentUser = {
                            username: username,
                            admin: userData.admin || false,
                            name: userData.name || username
                        };
                        
                        // Armazenar sessão
                        saveUserSession(currentUser);
                        
                        // Atualizar último login
                        await update(ref(database, `users/${username}`), {
                            lastLogin: new Date().toISOString()
                        });
                        
                        showConnectionStatus('Login realizado com sucesso!', 'success');
                        showMainInterface();
                        loadChamados();
                        
                        // Carregar usuários se for admin
                        if (currentUser.admin) {
                            loadUsers();
                        }
                        
                        return true;
                    }
                }
                
                showConnectionStatus('Usuário ou senha inválidos', 'error');
                return false;
            } catch (error) {
                console.error('Erro no login:', error);
                showConnectionStatus('Erro ao fazer login. Tente novamente.', 'error');
                return false;
            }
        }

        // Exibir interface principal após o login
        function showMainInterface() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('controls').classList.remove('hidden');
            document.getElementById('statsCards').classList.remove('hidden');
            document.getElementById('chamadosContainer').classList.remove('hidden');
            
            // Mostrar seção de admin se for admin
            if (currentUser.admin) {
                document.getElementById('adminSection').classList.remove('hidden');
            } else {
                document.getElementById('adminSection').classList.add('hidden');
            }
            
            document.getElementById('currentUser').textContent = currentUser.name || currentUser.username;
        }

        function showLoginModal() {
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').classList.add('hidden');
        }

        // Carregar chamados do banco de dados
        async function loadChamados() {
            try {
                showConnectionStatus('Carregando chamados...', 'info');
                
                const chamadosRef = ref(database, 'chamados');
                const snapshot = await get(chamadosRef);
                
                if (snapshot.exists()) {
                    chamadosData = snapshot.val();
                } else {
                    chamadosData = {};
                }
                
                displayChamados();
                updateStatistics();
                
                setTimeout(() => {
                    document.getElementById('connectionStatus').classList.add('hidden');
                }, 2000);
            } catch (error) {
                console.error('Erro ao carregar chamados:', error);
                showConnectionStatus('Erro ao carregar chamados', 'error');
            }
        }

        // Carregar usuários do banco de dados (apenas para admin)
        async function loadUsers() {
            if (!currentUser?.admin) return;
            
            try {
                const usersRef = ref(database, 'users');
                const snapshot = await get(usersRef);
                
                if (snapshot.exists()) {
                    usersData = snapshot.val();
                    displayUsers();
                } else {
                    usersData = {};
                    document.getElementById('usersList').innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-users text-4xl mb-4"></i>
                            <p>Nenhum usuário encontrado</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar usuários:', error);
                showConnectionStatus('Erro ao carregar usuários', 'error');
            }
        }

        // Exibir lista de usuários (apenas para admin)
        function displayUsers() {
            if (!currentUser?.admin) return;
            
            const container = document.getElementById('usersList');
            
            if (!usersData || Object.keys(usersData).length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-users text-4xl mb-4"></i>
                        <p>Nenhum usuário encontrado</p>
                    </div>
                `;
                return;
            }
            
            const usersArray = Object.entries(usersData).map(([username, user]) => ({
                username,
                ...user
            }));
            
            container.innerHTML = usersArray.map(user => `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="flex items-center gap-2">
                                <h3 class="font-semibold text-gray-800">${user.name || user.username}</h3>
                                ${user.admin ? 
                                    `<span class="px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-800">
                                        Admin
                                    </span>` : 
                                    `<span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">
                                        Usuário
                                    </span>`
                                }
                            </div>
                            <p class="text-sm text-gray-600 mt-1">Usuário: ${user.username}</p>
                            ${user.lastLogin ? 
                                `<p class="text-xs text-gray-500 mt-1">
                                    Último acesso: ${new Date(user.lastLogin).toLocaleString('pt-BR')}
                                </p>` : ''
                            }
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editUser('${user.username}')" 
                                    class="text-blue-600 hover:text-blue-800 p-1" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${user.username !== currentUser.username ? 
                                `<button onclick="deleteUser('${user.username}')" 
                                        class="text-red-600 hover:text-red-800 p-1" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>` : ''
                            }
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Exibir chamados na interface
        function displayChamados(filteredData = null) {
            const container = document.getElementById('chamadosList');
            const data = filteredData || chamadosData;
            
            if (!data || Object.keys(data).length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-4"></i>
                        <p>Nenhum chamado encontrado</p>
                    </div>
                `;
                return;
            }
            
            const chamadosArray = Object.entries(data).map(([id, chamado]) => ({
                id,
                ...chamado
            }));
            
            chamadosArray.sort((a, b) => new Date(b.dataAbertura) - new Date(a.dataAbertura));
            
            container.innerHTML = chamadosArray.map(chamado => `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow mb-4">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-4 mb-2">
                                <h3 class="font-semibold text-gray-800">${chamado.chamado}</h3>
                                <span class="px-2 py-1 text-xs rounded-full ${getStatusClass(chamado.status)}">
                                    ${chamado.status}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600 mb-1">
                                <i class="fas fa-user mr-1"></i>Analista: ${chamado.analista}
                            </p>
                            <p class="text-sm text-gray-600 mb-1">
                                <i class="fas fa-desktop mr-1"></i>Sistema: ${chamado.sistema}
                            </p>
                            <p class="text-sm text-gray-600">
                                <i class="fas fa-calendar mr-1"></i>Abertura: ${formatDate(chamado.dataAbertura)}
                            </p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="viewChamado('${chamado.id}')" 
                                    class="text-gray-600 hover:text-gray-800 p-1" title="Visualizar">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editChamado('${chamado.id}')" 
                                    class="text-blue-600 hover:text-blue-800 p-1" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteChamado('${chamado.id}')" 
                                    class="text-red-600 hover:text-red-800 p-1" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded p-3 mt-3">
                        <p class="text-sm text-gray-700">
                            <strong>Assunto:</strong> ${chamado.assunto}
                        </p>
                        ${chamado.atualizacaoInicial ? `
                            <p class="text-sm text-gray-700 mt-2">
                                <strong>Atualização:</strong> ${chamado.atualizacaoInicial}
                            </p>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Visualizar detalhes de um chamado
        function viewChamado(id) {
            const chamado = chamadosData[id];
            if (!chamado) return;
            
            currentViewChamadoId = id;
            
            document.getElementById('viewModalTitle').textContent = `Chamado: ${chamado.chamado}`;
            
            // Exibir detalhes do chamado
            document.getElementById('chamadoDetails').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Analista</h3>
                        <p class="mt-1 text-gray-900">${chamado.analista}</p>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Status</h3>
                        <p class="mt-1">
                            <span class="px-2 py-1 text-xs rounded-full ${getStatusClass(chamado.status)}">
                                ${chamado.status}
                            </span>
                        </p>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Sistema</h3>
                        <p class="mt-1 text-gray-900">${chamado.sistema}</p>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Cenário</h3>
                        <p class="mt-1 text-gray-900">${chamado.cenario}</p>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Data de Abertura</h3>
                        <p class="mt-1 text-gray-900">${formatDate(chamado.dataAbertura)}</p>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Data de Envio N3</h3>
                        <p class="mt-1 text-gray-900">${formatDate(chamado.dataEnvioN3)}</p>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Fila</h3>
                        <p class="mt-1 text-gray-900">${chamado.fila}</p>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Criado por</h3>
                        <p class="mt-1 text-gray-900">${chamado.createdBy || "Não informado"}</p>
                    </div>
                </div>
                <div class="mt-4">
                    <h3 class="text-sm font-medium text-gray-500">Assunto do E-mail</h3>
                    <p class="mt-1 text-gray-900">${chamado.assunto}</p>
                </div>
                ${chamado.atualizacaoInicial ? `
                    <div class="mt-4">
                        <h3 class="text-sm font-medium text-gray-500">Atualização Inicial</h3>
                        <p class="mt-1 text-gray-900">${chamado.atualizacaoInicial}</p>
                    </div>
                ` : ''}
            `;
            
            // Carregar atualizações do chamado
            loadChamadoUpdates(id);
            
            document.getElementById('viewChamadoModal').classList.remove('hidden');
        }

        // Carregar atualizações de um chamado
        async function loadChamadoUpdates(chamadoId) {
            try {
                const updatesRef = ref(database, `chamados/${chamadoId}/updates`);
                const snapshot = await get(updatesRef);
                
                const updatesContainer = document.getElementById('chamadoUpdates');
                
                if (snapshot.exists()) {
                    const updates = snapshot.val();
                    const updatesArray = Object.entries(updates).map(([id, update]) => ({
                        id,
                        ...update
                    }));
                    
                    updatesArray.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    updatesContainer.innerHTML = updatesArray.map(update => `
                        <div class="border-l-4 border-blue-500 pl-4 py-2">
                            <p class="text-sm text-gray-900">${update.content}</p>
                            <div class="flex justify-between mt-2">
                                <p class="text-xs text-gray-500">Por: ${update.by}</p>
                                <p class="text-xs text-gray-500">${formatDateTime(update.timestamp)}</p>
                            </div>
                        </div>
                    `).join('');
                } else {
                    updatesContainer.innerHTML = `
                        <div class="text-center py-4 text-gray-500">
                            <p>Nenhuma atualização encontrada</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar atualizações:', error);
                document.getElementById('chamadoUpdates').innerHTML = `
                    <div class="text-center py-4 text-red-500">
                        <p>Erro ao carregar atualizações</p>
                    </div>
                `;
            }
        }

        // Adicionar uma atualização a um chamado
        async function addChamadoUpdate(chamadoId, content) {
            try {
                const updateData = {
                    content: content,
                    by: currentUser.name || currentUser.username,
                    timestamp: new Date().toISOString()
                };
                
                const updatesRef = ref(database, `chamados/${chamadoId}/updates`);
                await push(updatesRef, updateData);
                
                showConnectionStatus('Atualização adicionada com sucesso!', 'success');
                loadChamadoUpdates(chamadoId);
                document.getElementById('updateForm').reset();
            } catch (error) {
                console.error('Erro ao adicionar atualização:', error);
                showConnectionStatus('Erro ao adicionar atualização', 'error');
            }
        }

        // Editar um chamado
        function editChamado(id) {
            const chamado = chamadosData[id];
            if (!chamado) return;
            
            // Preencher formulário com dados existentes
            document.getElementById('analista').value = chamado.analista || '';
            document.getElementById('chamado').value = chamado.chamado || '';
            document.getElementById('sistema').value = chamado.sistema || '';
            document.getElementById('cenario').value = chamado.cenario || '';
            document.getElementById('assunto').value = chamado.assunto || '';
            document.getElementById('dataAbertura').value = formatDateForInput(chamado.dataAbertura);
            document.getElementById('dataEnvioN3').value = formatDateForInput(chamado.dataEnvioN3);
            document.getElementById('fila').value = chamado.fila || '';
            document.getElementById('status').value = chamado.status || '';
            document.getElementById('atualizacaoInicial').value = chamado.atualizacaoInicial || '';
            
            document.getElementById('modalTitle').textContent = 'Editar Chamado';
            document.getElementById('chamadoModal').classList.remove('hidden');
            document.getElementById('chamadoForm').dataset.editId = id;
        }

        // Editar um usuário
        function editUser(username) {
            if (!currentUser?.admin) return;
            
            const user = usersData[username];
            if (!user) return;
            
            // Preencher formulário com dados existentes
            document.getElementById('newUsername').value = username;
            document.getElementById('newUsername').disabled = true; // Não permitir editar o username
            document.getElementById('newPassword').value = user.password || '';
            document.getElementById('name').value = user.name || '';
            document.getElementById('isAdmin').checked = user.admin || false;
            
            document.getElementById('userModalTitle').textContent = 'Editar Usuário';
            document.getElementById('userModal').classList.remove('hidden');
            document.getElementById('userForm').dataset.editUsername = username;
        }

        // Funções auxiliares
        function getStatusClass(status) {
            switch (status) {
                case 'Pendente':
                    return 'bg-yellow-100 text-yellow-800';
                case 'Em Andamento':
                    return 'bg-blue-100 text-blue-800';
                case 'Concluído':
                    return 'bg-green-100 text-green-800';
                case 'Cancelado':
                    return 'bg-red-100 text-red-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('pt-BR');
        }

        function formatDateTime(dateString) {
            return new Date(dateString).toLocaleString('pt-BR');
        }

        function formatDateForInput(dateString) {
            const date = new Date(dateString);
            return date.toISOString().split('T')[0];
        }

        // Atualizar estatísticas
        function updateStatistics() {
            const chamados = Object.values(chamadosData);
            
            document.getElementById('totalChamados').textContent = chamados.length;
            document.getElementById('pendenteChamados').textContent = 
                chamados.filter(c => c.status === 'Pendente').length;
            document.getElementById('andamentoChamados').textContent = 
                chamados.filter(c => c.status === 'Em Andamento').length;
            document.getElementById('concluidoChamados').textContent = 
                chamados.filter(c => c.status === 'Concluído').length;
        }

        // Configurar busca e filtros
        function setupSearchAndFilter() {
            const searchInput = document.getElementById('searchInput');
            const statusFilter = document.getElementById('statusFilter');
            
            function filterChamados() {
                const searchTerm = searchInput.value.toLowerCase();
                const statusValue = statusFilter.value;
                
                let filtered = { ...chamadosData };
                
                if (searchTerm) {
                    filtered = Object.fromEntries(
                        Object.entries(filtered).filter(([id, chamado]) =>
                            chamado.analista?.toLowerCase().includes(searchTerm) ||
                            chamado.chamado?.toLowerCase().includes(searchTerm) ||
                            chamado.assunto?.toLowerCase().includes(searchTerm) ||
                            chamado.sistema?.toLowerCase().includes(searchTerm) ||
                            chamado.cenario?.toLowerCase().includes(searchTerm)
                        )
                    );
                }
                
                if (statusValue) {
                    filtered = Object.fromEntries(
                        Object.entries(filtered).filter(([id, chamado]) =>
                            chamado.status === statusValue
                        )
                    );
                }
                
                displayChamados(filtered);
            }
            
            searchInput.addEventListener('input', filterChamados);
            statusFilter.addEventListener('change', filterChamados);
        }

        // Operações CRUD para chamados
        async function saveChamado(chamadoData) {
            try {
                const chamadosRef = ref(database, 'chamados');
                const newChamado = {
                    ...chamadoData,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.name || currentUser.username
                };
                
                await push(chamadosRef, newChamado);
                
                await loadChamados();
                showConnectionStatus('Chamado salvo com sucesso!', 'success');
                return true;
            } catch (error) {
                console.error('Erro ao salvar chamado:', error);
                showConnectionStatus('Erro ao salvar chamado', 'error');
                return false;
            }
        }

        async function updateChamado(id, chamadoData) {
            try {
                // Manter atualizações existentes
                const chamadoRef = ref(database, `chamados/${id}`);
                const snapshot = await get(chamadoRef);
                let updates = {};
                
                if (snapshot.exists()) {
                    const currentData = snapshot.val();
                    if (currentData.updates) {
                        updates = currentData.updates;
                    }
                }
                
                await set(ref(database, `chamados/${id}`), {
                    ...chamadoData,
                    updates: updates,
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser.name || currentUser.username
                });
                
                await loadChamados();
                showConnectionStatus('Chamado atualizado com sucesso!', 'success');
                return true;
            } catch (error) {
                console.error('Erro ao atualizar chamado:', error);
                showConnectionStatus('Erro ao atualizar chamado', 'error');
                return false;
            }
        }

        async function deleteChamado(id) {
            if (!confirm('Tem certeza que deseja excluir este chamado?')) {
                return;
            }
            
            try {
                await remove(ref(database, `chamados/${id}`));
                await loadChamados();
                showConnectionStatus('Chamado excluído com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao excluir chamado:', error);
                showConnectionStatus('Erro ao excluir chamado', 'error');
            }
        }

        // Operações CRUD para usuários
        async function saveUser(userData) {
            if (!currentUser?.admin) return false;
            
            try {
                const username = userData.username;
                const userRef = ref(database, `users/${username}`);
                
                // Verificar se já existe
                const snapshot = await get(userRef);
                if (snapshot.exists()) {
                    showConnectionStatus('Usuário já existe', 'error');
                    return false;
                }
                
                await set(userRef, {
                    password: userData.password,
                    name: userData.name,
                    admin: userData.isAdmin === 'on',
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.username
                });
                
                await loadUsers();
                showConnectionStatus('Usuário adicionado com sucesso!', 'success');
                return true;
            } catch (error) {
                console.error('Erro ao adicionar usuário:', error);
                showConnectionStatus('Erro ao adicionar usuário', 'error');
                return false;
            }
        }

        async function updateUser(username, userData) {
            if (!currentUser?.admin) return false;
            
            try {
                // Manter dados existentes não fornecidos no formulário
                const userRef = ref(database, `users/${username}`);
                const snapshot = await get(userRef);
                let existingData = {};
                
                if (snapshot.exists()) {
                    existingData = snapshot.val();
                }
                
                await update(ref(database, `users/${username}`), {
                    password: userData.password,
                    name: userData.name,
                    admin: userData.isAdmin === 'on',
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser.username,
                    createdAt: existingData.createdAt || new Date().toISOString(),
                    createdBy: existingData.createdBy || currentUser.username
                });
                
                await loadUsers();
                showConnectionStatus('Usuário atualizado com sucesso!', 'success');
                return true;
            } catch (error) {
                console.error('Erro ao atualizar usuário:', error);
                showConnectionStatus('Erro ao atualizar usuário', 'error');
                return false;
            }
        }

        async function deleteUser(username) {
            if (!currentUser?.admin || username === currentUser.username) return;
            
            if (!confirm(`Tem certeza que deseja excluir o usuário ${username}?`)) {
                return;
            }
            
            try {
                await remove(ref(database, `users/${username}`));
                await loadUsers();
                showConnectionStatus('Usuário excluído com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao excluir usuário:', error);
                showConnectionStatus('Erro ao excluir usuário', 'error');
            }
        }

        // Exportar para Excel
        function exportToExcel() {
            try {
                const chamados = Object.entries(chamadosData).map(([id, chamado]) => ({
                    ID: id,
                    ...chamado,
                    createdAt: chamado.createdAt ? new Date(chamado.createdAt).toLocaleString('pt-BR') : '',
                    dataAbertura: formatDate(chamado.dataAbertura),
                    dataEnvioN3: formatDate(chamado.dataEnvioN3)
                }));
                
                if (chamados.length === 0) {
                    alert('Não há dados para exportar');
                    return;
                }
                
                const ws = XLSX.utils.json_to_sheet(chamados);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Chamados");
                
                // Ajustar larguras das colunas
                const colWidths = [
                    { wch: 20 }, // ID
                    { wch: 15 }, // analista
                    { wch: 15 }, // chamado
                    { wch: 15 }, // sistema
                    { wch: 20 }, // cenario
                    { wch: 40 }, // assunto
                    { wch: 15 }, // dataAbertura
                    { wch: 15 }, // dataEnvioN3
                    { wch: 15 }, // fila
                    { wch: 15 }, // status
                    { wch: 40 }, // atualizacaoInicial
                    { wch: 20 }, // createdAt
                    { wch: 15 }  // createdBy
                ];
                ws['!cols'] = colWidths;
                
                const filename = `chamados_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, filename);
                
                showConnectionStatus('Dados exportados com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao exportar:', error);
                showConnectionStatus('Erro ao exportar dados', 'error');
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar Firebase
            if (!initializeFirebase()) {
                return;
            }
            
            // Login form
            document.getElementById('loginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                
                if (!username || !password) {
                    document.getElementById('loginError').classList.remove('hidden');
                    document.getElementById('loginErrorText').textContent = 'Preencha todos os campos';
                    return;
                }
                
                document.getElementById('loginError').classList.add('hidden');
                
                const success = await login(username, password);
                if (!success) {
                    document.getElementById('loginError').classList.remove('hidden');
                    document.getElementById('loginErrorText').textContent = 'Usuário ou senha incorretos';
                }
            });
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', function() {
                clearUserSession();
                currentUser = null;
                chamadosData = {};
                usersData = {};
                
                // Esconder interface principal
                document.getElementById('userInfo').classList.add('hidden');
                document.getElementById('controls').classList.add('hidden');
                document.getElementById('statsCards').classList.add('hidden');
                document.getElementById('chamadosContainer').classList.add('hidden');
                document.getElementById('adminSection').classList.add('hidden');
                
                // Mostrar login modal
                showLoginModal();
            });
            
            // Botão de adicionar chamado
            document.getElementById('addChamadoBtn').addEventListener('click', function() {
                document.getElementById('modalTitle').textContent = 'Novo Chamado';
                document.getElementById('chamadoForm').reset();
                delete document.getElementById('chamadoForm').dataset.editId;
                
                // Preencher com data atual
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('dataAbertura').value = today;
                document.getElementById('dataEnvioN3').value = today;
                
                // Preencher com nome do analista atual
                document.getElementById('analista').value = currentUser.name || currentUser.username;
                
                document.getElementById('chamadoModal').classList.remove('hidden');
            });
            
            // Botão de adicionar usuário
            document.getElementById('addUserBtn')?.addEventListener('click', function() {
                document.getElementById('userModalTitle').textContent = 'Novo Usuário';
                document.getElementById('userForm').reset();
                document.getElementById('newUsername').disabled = false;
                delete document.getElementById('userForm').dataset.editUsername;
                
                document.getElementById('userModal').classList.remove('hidden');
            });
            
            // Fechar modais
            document.getElementById('closeModalBtn').addEventListener('click', function() {
                document.getElementById('chamadoModal').classList.add('hidden');
            });
            
            document.getElementById('cancelBtn').addEventListener('click', function() {
                document.getElementById('chamadoModal').classList.add('hidden');
            });
            
            document.getElementById('closeUserModalBtn')?.addEventListener('click', function() {
                document.getElementById('userModal').classList.add('hidden');
            });
            
            document.getElementById('cancelUserBtn')?.addEventListener('click', function() {
                document.getElementById('userModal').classList.add('hidden');
            });
            
            document.getElementById('closeViewModalBtn').addEventListener('click', function() {
                document.getElementById('viewChamadoModal').classList.add('hidden');
                currentViewChamadoId = null;
            });
            
            // Formulário de chamado
            document.getElementById('chamadoForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const chamadoData = Object.fromEntries(formData.entries());
                
                // Validar campos obrigatórios
                const requiredFields = ['analista', 'chamado', 'sistema', 'cenario', 'assunto', 'dataAbertura', 'dataEnvioN3', 'fila', 'status'];
                const missingFields = requiredFields.filter(field => !chamadoData[field]);
                
                if (missingFields.length > 0) {
                    alert('Por favor, preencha todos os campos obrigatórios: ' + missingFields.join(', '));
                    return;
                }
                
                const editId = e.target.dataset.editId;
                let success;
                
                if (editId) {
                    success = await updateChamado(editId, chamadoData);
                } else {
                    success = await saveChamado(chamadoData);
                }
                
                if (success) {
                    document.getElementById('chamadoModal').classList.add('hidden');
                }
            });
            
            // Formulário de usuário
            document.getElementById('userForm')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const userData = Object.fromEntries(formData.entries());
                
                // Validar campos obrigatórios
                const requiredFields = ['username', 'password'];
                const missingFields = requiredFields.filter(field => !userData[field]);
                
                if (missingFields.length > 0) {
                    alert('Por favor, preencha todos os campos obrigatórios: ' + missingFields.join(', '));
                    return;
                }
                
                const editUsername = e.target.dataset.editUsername;
                let success;
                
                if (editUsername) {
                    success = await updateUser(editUsername, userData);
                } else {
                    success = await saveUser(userData);
                }
                
                if (success) {
                    document.getElementById('userModal').classList.add('hidden');
                }
            });
            
            // Formulário de atualização de chamado
            document.getElementById('updateForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!currentViewChamadoId) return;
                
                const updateContent = document.getElementById('updateContent').value.trim();
                if (!updateContent) {
                    alert('Por favor, digite uma atualização');
                    return;
                }
                
                await addChamadoUpdate(currentViewChamadoId, updateContent);
            });
            
            // Botão de exportar
            document.getElementById('exportBtn').addEventListener('click', exportToExcel);
            
            // Setup de busca e filtro
            setupSearchAndFilter();
            
            // Definir data atual como padrão para novos chamados
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dataAbertura').value = today;
            document.getElementById('dataEnvioN3').value = today;
        });

        // Funções globais para eventos onclick do HTML
        window.viewChamado = viewChamado;
        window.editChamado = editChamado;
        window.deleteChamado = deleteChamado;
        window.editUser = editUser;
        window.deleteUser = deleteUser;
    </script>
</body>
</html>
