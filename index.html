<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>PlanEmailH</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"></script>
<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: #f0f2f5;
  color: #333;
  margin: 0; padding: 20px;
}
.container {
  max-width: 1200px;
  margin: auto;
  background: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
form {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 10px;
  margin-bottom: 20px;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}
th, td {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: left;
}
tr.concluido {
  background: #eee;
  color: #888;
}
button.small {
  font-size: 12px;
  padding: 2px 4px;
  margin: 0 1px;
}
</style>
</head>
<body>
<div class="container">
  <h2>PlanEmailH</h2>

  <form id="form">
    <input type="text" id="analista" placeholder="Analista" required>
    <input type="text" id="chamado" placeholder="Chamado" required>
    <input type="date" id="dataAbertura" required>
    <input type="date" id="dataEnvioN3" required>
    <input type="text" id="fila" placeholder="Fila" required>
    <select id="status">
      <option value="Aguardando Fornecedor">Aguardando Fornecedor</option>
      <option value="NÃ£o enviado ao N3">NÃ£o enviado ao N3</option>
      <option value="Resolvido">Resolvido</option>
      <option value="Outros">Outros</option>
    </select>
    <input type="text" id="atualizacao" placeholder="AtualizaÃ§Ã£o">
    <button type="submit">Inserir</button>
  </form>

  <button onclick="carregar()">ðŸ”„ Atualizar Tabela</button>
  <button onclick="organizarPorAnalista = true; carregar();">ðŸ‘¤ Organizar por Analista</button>

  <table>
    <thead>
      <tr>
        <th>SemÃ¡foro</th>
        <th>Analista</th>
        <th>Chamado</th>
        <th>Data Abertura</th>
        <th>Data Envio N3</th>
        <th>Fila</th>
        <th>Status</th>
        <th>AtualizaÃ§Ã£o</th>
        <th>Data AtualizaÃ§Ã£o</th>
        <th>AÃ§Ãµes</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
const firebaseConfig = {
  // ðŸ”· coloque aqui a sua configuraÃ§Ã£o do Firebase
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const tbody = document.getElementById('tbody');
let organizarPorAnalista = false;

document.getElementById('form').addEventListener('submit', e => {
  e.preventDefault();
  const dados = {
    analista: form.analista.value,
    chamado: form.chamado.value,
    dataAbertura: form.dataAbertura.value,
    dataEnvioN3: form.dataEnvioN3.value,
    fila: form.fila.value,
    status: form.status.value,
    atualizacao: form.atualizacao.value,
    dataAtualizacao: "",
    concluido: false,
    criadoEm: Date.now()
  };
  db.ref('planemailh/').push(dados).then(() => {
    form.reset();
    carregar();
  });
});

function atualizar(key) {
  const novaAtualizacao = prompt("Nova atualizaÃ§Ã£o:");
  if (!novaAtualizacao) return;
  const dataAtual = new Date().toISOString();
  db.ref(`planemailh/${key}`).update({
    atualizacao: novaAtualizacao,
    dataAtualizacao: dataAtual
  }).then(carregar);
}

function concluir(key) {
  db.ref(`planemailh/${key}`).update({ concluido: true }).then(carregar);
}

function ordemTermometro(a, b) {
  const diffA = calcDiffDays(a.dataAtualizacao);
  const diffB = calcDiffDays(b.dataAtualizacao);
  return diffB - diffA; // vermelho primeiro
}

function carregar() {
  db.ref('planemailh/').once('value').then(snap => {
    let ativos = [], concluidos = [];
    snap.forEach(child => {
      const d = child.val();
      d.key = child.key;
      if (d.concluido) concluidos.push(d);
      else ativos.push(d);
    });

    if (organizarPorAnalista) {
      const analistaAtual = prompt("Qual analista para priorizar?") || '';
      ativos.sort((a, b) => {
        if (a.analista === analistaAtual && b.analista !== analistaAtual) return -1;
        if (a.analista !== analistaAtual && b.analista === analistaAtual) return 1;
        return ordemTermometro(a, b) || a.criadoEm - b.criadoEm;
      });
    } else {
      ativos.sort((a, b) => ordemTermometro(a, b) || a.criadoEm - b.criadoEm);
    }

    tbody.innerHTML = "";
    [...ativos, ...concluidos].forEach(d => {
      const tr = document.createElement("tr");
      if (d.concluido) tr.classList.add("concluido");

      const diff = calcDiffDays(d.dataAtualizacao);
      let semaforo = '';
      if (!d.concluido) {
        if (diff === 0) semaforo = `ðŸŸ¢`;
        else if (diff === 1) semaforo = `ðŸŸ¢`;
        else if (diff === 2) semaforo = `ðŸŸ¡`;
        else semaforo = `ðŸ”´`;
      }

      tr.innerHTML = `
        <td>${semaforo}</td>
        <td>${d.analista}</td>
        <td>${d.chamado}</td>
        <td>${d.dataAbertura}</td>
        <td>${d.dataEnvioN3}</td>
        <td>${d.fila}</td>
        <td>${d.status}</td>
        <td>${d.atualizacao || '-'}</td>
        <td>${formatarData(d.dataAtualizacao) || '-'}</td>
        <td>
          ${!d.concluido ? `
          <button class="small" onclick="atualizar('${d.key}')">ðŸ”„</button>
          <button class="small" onclick="concluir('${d.key}')">âœ…</button>` : ''}
        </td>
      `;
      tbody.appendChild(tr);
    });
    organizarPorAnalista = false;
  });
}

function calcDiffDays(data) {
  if (!data) return 999;
  const dt = new Date(data);
  const hoje = new Date();
  const diff = (hoje - dt) / (1000 * 60 * 60 * 24);
  return Math.floor(diff);
}

function formatarData(data) {
  if (!data) return "";
  const d = new Date(data);
  return `${d.getDate().toString().padStart(2,0)}/${(d.getMonth()+1).toString().padStart(2,0)}/${d.getFullYear()} ${d.getHours()}:${d.getMinutes()}:${d.getSeconds()}`;
}

window.onload = carregar;
</script>
</body>
</html>
